# Generated by ForkLaunch
# File: docker-compose.yaml
# This is an auto-generated file. Modifications are encouraged but may inhibit automated upgrades.

volumes:
  dice-roll-node-app-postgresql-data:
    driver: local
networks:
  dice-roll-node-app-network:
    name: dice-roll-node-app-network
    driver: bridge
services:
  tempo:
    image: grafana/tempo:latest
    ports:
    - '3200:3200'
    - '4317:4317'
    networks:
    - dice-roll-node-app-network
    volumes:
    - './src/modules/monitoring/tempo.yaml:/etc/tempo.yaml'
    command: '-config.file=/etc/tempo.yaml'
    healthcheck:
      test:
      - CMD
      - wget
      - '--no-verbose'
      - '--tries=1'
      - '--spider'
      - http://localhost:3200/ready
      interval: '30s'
      timeout: '10s'
      retries: 3
      start_period: '60s'
  loki:
    image: grafana/loki:latest
    ports:
    - '3100:3100'
    networks:
    - dice-roll-node-app-network
    healthcheck:
      test:
      - CMD
      - wget
      - '--no-verbose'
      - '--tries=1'
      - '--spider'
      - http://localhost:3100/ready
      interval: '30s'
      timeout: '10s'
      retries: 3
      start_period: '30s'
  prometheus:
    image: prom/prometheus:latest
    ports:
    - '9090:9090'
    networks:
    - dice-roll-node-app-network
    volumes:
    - './src/modules/monitoring/prometheus.yaml:/etc/prometheus/prometheus.yml'
    healthcheck:
      test:
      - CMD
      - wget
      - '--no-verbose'
      - '--tries=1'
      - '--spider'
      - http://localhost:9090/-/healthy
      interval: '30s'
      timeout: '10s'
      retries: 3
      start_period: '30s'
  grafana:
    image: grafana/grafana:latest
    ports:
    - '3000:3000'
    networks:
    - dice-roll-node-app-network
    volumes:
    - './src/modules/monitoring/grafana-provisioning/datasources:/etc/grafana/provisioning/datasources'
    - './src/modules/monitoring/grafana-provisioning/dashboards:/etc/grafana/provisioning/dashboards'
    healthcheck:
      test:
      - CMD
      - wget
      - '--no-verbose'
      - '--tries=1'
      - '--spider'
      - http://localhost:3000/api/health
      interval: '30s'
      timeout: '10s'
      retries: 3
      start_period: '30s'
  otel-collector:
    image: otel/opentelemetry-collector:latest
    ports:
    - '4318:4318'
    - '8889:8889'
    networks:
    - dice-roll-node-app-network
    volumes:
    - './src/modules/monitoring/otel-collector-config.yaml:/etc/otel-collector-config.yaml'
    command: '--config=/etc/otel-collector-config.yaml'
  postgresql:
    hostname: postgresql
    container_name: dice-roll-node-app-postgresql
    image: postgres:latest
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgresql
      POSTGRES_PASSWORD: postgresql
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
    - '5432:5432'
    networks:
    - dice-roll-node-app-network
    volumes:
    - dice-roll-node-app-postgresql-data:/var/lib/postgresql
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U postgresql -d dice-roll-node-app-roll-dice-svc-dev -h localhost
      interval: '10s'
      timeout: '5s'
      retries: 5
      start_period: '30s'
  roll-dice-svc:
    hostname: roll-dice-svc
    container_name: dice-roll-node-app-roll-dice-svc-node
    image: dice-roll-node-app-roll-dice-svc-node:latest
    restart: always
    build:
      context: './src/modules'
      dockerfile: './Dockerfile'
    environment:
      NODE_ENV: development
      HOST: '0.0.0.0'
      PROTOCOL: http
      PORT: '8000'
      VERSION: v1
      DOCS_PATH: /docs
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: dice-roll-node-app-roll-dice-svc
      DB_NAME: dice-roll-node-app-roll-dice-svc-dev
      DB_HOST: postgresql
      DB_USER: postgresql
      DB_PASSWORD: postgresql
      DB_PORT: '5432'
    depends_on:
      postgresql:
        condition: service_started
    ports:
    - '8000:8000'
    networks:
    - dice-roll-node-app-network
    volumes:
    - './src/modules/roll-dice-svc:/dice-roll-node-app/roll-dice-svc'
    - /dice-roll-node-app/roll-dice-svc/dist
    - /dice-roll-node-app/roll-dice-svc/node_modules
    - /dice-roll-node-app/core/node_modules
    - /dice-roll-node-app/monitoring/node_modules
    - /dice-roll-node-app/universal-sdk/node_modules
    - /dice-roll-node-app/node_modules
    working_dir: /dice-roll-node-app/roll-dice-svc
    entrypoint:
    - pnpm
    - run
    - dev
    healthcheck:
      test:
      - CMD
      - curl
      - '-f'
      - http://localhost:8000/health
      interval: '30s'
      timeout: '10s'
      retries: 3
      start_period: '40s'
